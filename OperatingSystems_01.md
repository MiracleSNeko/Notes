# 操作系统

> 王道考研操作系统教程：BV1YE411D7nH

## 1. 操作系统基本概念

### 1.1 操作系统的定义

*   计算机系统的层次结构（由下到上）

    -   计算机硬件
    -   操作系统
    -   计算机软件
    -   用户（用户可以直接和操作系统进行部分交互）

*   操作系统作用

    -   操作系统负责管理协调硬件、软件等计算机资源的工作
    -   为上层的应用程序和用户提供简单易用的服务

*   操作系统定义

    操作系统是控制和管理整个计算机系统的硬件和软件资源，并合理地组织调度计算机的工作和资源的分配，以提供给用户和其他软件方便的接口和环境的计算机系统中最基本的**系统软件**。

### 1.2 操作系统的功能和目标

*   作为系统资源的管理者

    -   处理机管理
    -   存储器管理（内存管理）
    -   文件管理
    -   设备管理

*   作为用户和计算机硬件之间的接口

    -   命令接口

        -   联机命令接口（交互式命令接口）

            例如： 命令行交互

        -   脱机命令接口（批处理命令接口）

            例如：批处理文件

    -   程序接口（系统调用）

        例如：user32.dll

    -   图形用户界面 GUI

*   作为最接近硬件的层次

    -   对硬件机器的拓展

        没有任何软件支持的计算机称为**裸机**，覆盖了软件的机器称为扩充机器或**虚拟机**

### 1.3 操作系统的特征

*   并发
    -   并发指两个或多个事件在同一时间间隔发生，宏观上事件是同时发生的，但微观上是交替发生的
*   共享
    -   资源共享，指系统中的资源可供内存中多个并发执行的进程共同使用
        -   互斥共享：同一个时间段只允许一个进程访问资源
        -   同时共享：允许一个时间段内多个进程同时（宏观上）进行访问
*   虚拟
    -   虚拟是指将一个物理上的实体变为若干个逻辑上的对应物
    -   物理实体是实际存在，逻辑上对应物是用户感受的
    -   虚拟的实现分为**时分复用**和**空分复用**两种
*   异步
    -   多道程序环境下，允许多个程序并发执行，但是由于资源有限，进程的执行不可能一贯到底，而是“走走停停”，以不可预知的速度向前推进
*   并发和共享是操作系统两个最基本的特征

### 1.4 操作系统的分类

*   手工操作阶段
    -   主要缺点：用户独占全机，人机速度矛盾导致资源利用率极低
*   单道批处理系统
    -   引入脱机输入输出机属，并使用监督程序负责控制作业的输入输出
    -   监督程序是操作系统的雏形
    -   主要优点：缓解了一定程度的人机速度矛盾
    -   主要缺点：CPU 有大量时间在空闲等待 IO 完成，利用率依然很低
*   多道批处理系统
    -   计算机一次读入多道程序，并引入中断机属，由操作系统负责管理程序的运行，各个程序并发执行
    -   主要优点：多道程序并发执行，共享计算机资源，资源利用率大幅度提升，系统吞吐量增大
    -   主要缺点：用户响应时间长，没有人机交互功能
*   分时操作系统
    -   计算机以时间片为单位轮流为各个用户/作业服务，各个用户可以通过终端和计算机交互
    -   主要优点：用户请求可以被即时响应，解决了人机交互问题。允许多用户同时使用同一台计算机，并且用户对计算机的操作相互独立
    -   主要缺点：不能优先处理紧急任务
*   实时操作系统
    -   计算机系统接收到外部信号后即时进行处理，并且在严格的时限内处理完事件
    -   主要特点：及时性和可靠性
    -   主要优点：能够先响应紧急任务，某些紧急任务不需要时间片排队
    -   实时操作系统分类
        -   硬实时系统：必须在绝对严格的规定时间内完成处理，如导弹控制系统和自动驾驶系统等
        -   软实时系统：允许偶尔违反时间规定，如火车票订票系统
*   其他操作系统
    -   网络操作系统
    -   分布式操作系统
    -   个人计算机操作系统

### 1.5 操作系统的运行机制和体系结构

#### 1.5.1 运行机制

*   指令：处理器能识别和执行的最基本命令
*   指令分为特权指令（不允许用户程序使用）和非特权指令两种
*   为了让 CPU 判断当前是否可以执行特权指令，CPU 分为两种处理器状态：用户态（目态，此时只能执行非特权指令）和核心态（管态，两种指令都可以执行）
*   用程序状态寄存器 PSW 的某个标识位区分当前处理器处于什么状态
*   程序分为内核程序（运行在核心态）和应用程序（运行在用户态）两种

#### 1.5.2 体系结构

*   操作系统的功能并不是全都不可或缺的，分为内核功能和非内核功能两类
*   内核在计算机系统的层次结构中接近计算机硬件
*   内核包含时钟管理、中断处理、原语（设备驱动， CPU 切换等）、系统资源管理（进程管理、储存器管理、设备管理）等
    -   时钟管理：实现计时功能
    -   中断处理：负责实现中断机制
    -   原语：
        -   处于操作系统最底层，最接近硬件的部分
        -   运行具有原子性
        -   运行时间较短，调用频繁
    -   系统资源管理
        -   进程管理
        -   存储器管理
        -   设备管理
    -   时钟管理、中断处理和原语是与硬件关联较为紧密的模块
    -   系统资源管理不一定会被划归内核
*   操作系统的体系结构
    -   大内核
        -   将操作系统的主要功能模块都作为系统内核，运行在核心态
        -   优点：高性能
        -   缺点：内核代码庞大，难以维护
    -   微内核
        -   只保留最基本的功能
        -   优点：内核功能少，结构清晰
        -   缺点：需要频繁地在核心态和用户态之间切换，性能较低

### 1.6 中断和异常

*   多道批处理系统中引入了中断机制
*   多道程序并发执行的本质：发生中断就意味着需要操作系统的介入，开展管理工作
*   中断发生后， CPU 立刻进入核心态，当前运行的进程暂停运行，并由操作系统内核对中断进行处理
*   中断是 CPU 由用户态切换到核心态的唯一途径
*   中断的分类
    -   外中断（信号来源是 CPU 外部，与当前执行的指令无关）
        -   外设请求
        -   人工干预
    -   内中断（又称异常，信号来自 CPU 内部，与当前执行的指令有关）
        -   自愿中断：指令中断等
        -   强迫中断：硬件故障和软件中断等
    -   内中断的另一种分类方法
        -   trap（陷阱，陷入）：有意而为之的异常，如系统调用
        -   fault（故障）：由错误条件引起，可能被故障处理程序修复，如缺页
        -   abort（终止）：不可恢复的致命错误引起，终止处理程序不再将控制返回给引发终止的应用程序，如整数除零
*   外中断处理过程
    -   在用户态下执行完每个指令后， CPU 都要检查当前是否有外部中断信号
    -   如果检测到外部中断信号，保护被中断进程的 CPU 环境（如程序状态字 PSW ，程序计数器 PC 和各种通用寄存器等）
    -   根据中断信号类型转入相应的中断处理程序
    -   恢复原进程的 CPU 环境并退出中断，返回原进程继续往下执行

### 1.7 系统调用

#### 1.7.1 定义

*   应用程序通过系统调用请求操作系统的服务
*   系统中的各种共享资源由操作系统统一管理，在用户程序中，凡是与资源有关的操作（如储存分配，I/O 操作，文件管理等）都必须通过系统调用的方式向操作系统提出服务请求，由操作系统代为完成
*   系统调用可以保证系统的稳定性和安全性，防止用户进行非法操作
*   系统调用的相关处理在核心态下进行
*   系统调用的功能分类
    -   设备管理：完成设备的请求/释放/启动等功能
    -   文件管理：完成文件的创建/删除/读写功能
    -   进程控制：完成进程的创建/撤销/阻塞/唤醒等功能
    -   进程通信：完成进程之间的消息传递/信号传递等功能
    -   内存管理：完成内存的分配/回收等功能

#### 1.7.2 系统调用过程

*   高级语言的系统调用（汇编指令）封装在库函数中
*   系统调用流程
    -   传递系统调用参数 `int x`
    -   执行 trap 指令（用户态）
    -   执行系统调用相应服务程序（核心态）
    -   返回用户程序

#
- 下一节：[进程和线程](./OperatingSystems_02.md)